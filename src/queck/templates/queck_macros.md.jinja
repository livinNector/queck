{% macro render_overview(quiz)-%}
{%macro overview_row(name, type)-%}
{%-set questions = quiz.questions|selectattr('type', "equalto", type) | list -%}
| {{name}} | {{ questions | length }} | {{questions | map(attribute='marks') | sum}} |
{%-endmacro -%}
## Overview

| Question Type       | Count | Marks|
|---------------------|-------|------|
{{overview_row('Single Select','single_select')}}
{{overview_row('Multiple Select','multiple_select')}}
{{overview_row('Numerical','numerical_answer')}}
{{overview_row('Short Answer','short_answer')}}
{{overview_row('Common Data','common_data')}}

---
{%- endmacro %}
{% macro render_question(question, index=none, level=1,for_html_export=false) %}
{{"#"*level}}{%if index%} Question {{ index }}{%endif%} [{{ question.type.split('_') | join(" ") | title }}]{%if question.marks %} ({{question.marks}} marks){%endif%}

{%if question.tags-%}
***Tags:*** {% set comma = joiner(", ") -%}{%for tag in question.tags%}{{comma()}}`{{tag}}`{%endfor %}

{%endif -%}
{{-'\n<div class="fit-width">\n\n' if for_html_export else ''-}}
{{ question.text }}  
{{"\n\n</div>\n" if for_html_export else ''-}}
{% set answer = question.answer or None -%}
{% if answer.type in ['single_select_choices','multiple_select_choices'] -%}
{%- for choice in answer.root %}
- [{{ 'x' if choice.is_correct else ' '  }}] {{"<!---->\n    " if choice.text.startswith("```") or choice.text.startswith("$$")  else ""-}}
    {{ choice.text | indent(2) }}
    {%- if choice.feedback %}  
    _{{ choice.feedback }}_
    {%- endif -%}
{%- endfor -%}
{%- elif answer.type == "num_int" %}
**Answer:** ${{ answer.value }}$
{%- elif answer.type == "num_range" %}
**Answer:** ${{ answer.value.low }}$ to ${{ answer.value.high }}$
{%- elif answer.type == "num_tolerance" %}
**Answer:** ${{ answer.value.value }}$ Â± ${{ answer.value.tolerance }}$
{%- elif answer.type == "short_answer" %}
**Answer:** {{ answer.value }}
{%- endif %}
{%if question.feedback %}
{{'<div class="no-break">\n' if for_html_export else ''-}}
**Feedback**  
{{ question.feedback }}
{{'<div>\n' if for_html_export else ''-}}
{% endif -%}
{% endmacro -%}

{%- macro render_common_data_question(question, index, for_html_export=false)%}
{{-'<div class="no-break">\n' if for_html_export else ''}}
## {%if index%}Question {{index}} {%endif%}[Common Data]{%if question.marks %} ({{question.marks}} marks){%endif%}

### Common data{%if index%} for {{index}}.1 to {{index}}.{{question.questions |length}}{%endif%}

{{'\n<div class="fit-width">\n\n' if for_html_export else ''-}}
{{ question.text }}
{{-"\n\n</div>\n" if for_html_export else ''}}
{%for inner_question in question.questions -%}
{{-'\n<div class="no-break">\n' if for_html_export else ''-}}
{{ render_question(inner_question, index~"."~loop.index if index else loop.index, level=3, for_html_export=for_html_export) }}
{{-"\n</div>" if for_html_export else ''-}}
{%- endfor -%}
{% endmacro -%}

{%- macro render_quiz(quiz,overview,for_html_export=false)-%}

# {{ quiz.title }} {%if quiz.marks %}({{quiz.marks}} marks){%endif%}
{% if overview%}
{{render_overview(quiz)}}
{% endif -%}
{% set question_count = 0 -%}
{%- for item in quiz.questions -%}
{%- if item.type == "common_data" -%}
{%- set index = loop.index -%}
{{ render_common_data_question(item, loop.index, for_html_export=for_html_export)}}
{%- else -%}
{{-'\n<div class="no-break">\n' if for_html_export else ''-}}
{{ render_question(item, loop.index, level=2, for_html_export=for_html_export) }}
{{-"\n</div>\n" if for_html_export else ''-}}
{%- endif -%}
{%- endfor -%}
{% endmacro -%}