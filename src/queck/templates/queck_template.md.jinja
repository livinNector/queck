{% macro render_question(question, index, level=2) %}
{{"#"*level}} Question {{ index }} [{{ question.type.split('_') | join(" ") | title }}] {%if question.marks %}({{question.marks}} marks){%endif%}

{%if question.tags-%}
***Tags:*** {% set comma = joiner(", ") -%}{%for tag in question.tags%}{{comma()}}`{{tag}}`{%endfor %}

{%endif -%}
{{ question.text }}  
{% set answer = question.answer or None -%}
{% if answer.type in ['single_correct_choice','multiple_correct_choices'] -%}
{%- for choice in answer.root %}
  - [{{ 'x' if choice.is_correct else ' '  }}] {{"<!---->\n    " if choice.text.startswith("```") else ""-}}
      {{ choice.text | indent(4) }}
      {%- if choice.feedback %}  
      _{{ choice.feedback }}_
      {%- endif -%}
{%- endfor -%}
{%- elif answer.type == "true_false" %}
- [{{ 'x' if answer else ' '  }}] True
- [{{ 'x' if not answer else ' '  }}] False
{%- elif answer.type == "num_int" %}
**Answer:** ${{ answer.value }}$
{%- elif answer.type == "num_range" %}
**Answer:** ${{ answer.low }}$ to ${{ answer.high }}$
{%- elif answer.type == "num_tolerance" %}
**Answer:** ${{ answer.value }}$ Â± ${{ answer.tolerance }}$
{%- elif answer.type == "short_answer" %}
**Answer:** {{ answer.value }}
{%- endif %}
{%if question.feedback %}
**Feedback**  
{{ question.feedback }}
{% endif -%}
{% endmacro -%}
{%macro overview_row(name, type)-%}
{%-set questions = quiz.questions|selectattr('type', "equalto", type) | list -%}
| {{name}} | {{ questions | length }} | {{questions | map(attribute='marks') | sum}} |
{%-endmacro -%}
{%block body%}
# {{ quiz.title }} {%if quiz.marks %}({{quiz.marks}} marks){%endif%}

## Overview
| Question Type       | Count | Marks|
|---------------------|-------|------|
{{overview_row('Single Correct','multiple_choice')}}
{{overview_row('Multiple Correct','multiple_select')}}
{{overview_row('Numerical','numerical_answer')}}
{{overview_row('Short Answer','short_answer')}}
{{overview_row('Common Data','common_data')}}

---

{% set question_count = 0 -%}
{%- for item in quiz.questions -%}
{%- if item.type == "common_data" -%}
{%- set index = loop.index -%}
{{-'<div class="no-break">' if format=='html' else ''}}

## Question {{index}} [COMMON_DATA] {%if item.marks %}({{item.marks}} marks){%endif%}

### Common data for {{index}}.1 to {{index}}.{{item.questions |length}}

{{ item.text }}
{{-"\n</div>\n" if format=='html' else ''-}}
{%- for question in item.questions -%}
{{-'\n<div class="no-break">\n' if format=='html' else ''-}}
{{ render_question(question, index+0.1*loop.index, level=3) }}
{{-"\n</div>" if format=='html' else ''-}}
{%- endfor -%}
{%- else -%}
{{-'\n<div class="no-break">\n' if format=='html' else ''-}}
{{ render_question(item, loop.index) }}
{{-"\n</div>\n" if format=='html' else ''-}}
{%- endif -%}
{%- endfor -%}
{%endblock body%}